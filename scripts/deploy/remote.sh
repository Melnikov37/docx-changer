#!/bin/bash

# –£–¥–∞–ª–µ–Ω–Ω—ã–π –¥–µ–ø–ª–æ–π –¥–ª—è GitHub Actions (Docker –≤–µ—Ä—Å–∏—è)
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
#   ./deploy/remote.sh <host> <user> [--key-file <path>]
# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
#   SSH_KEY - —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ (–¥–ª—è GitHub Actions)
#   SSH_HOST - —Ö–æ—Å—Ç –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
#   SSH_USER - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
#   SECRET_KEY - Flask secret key
#   MINIO_ROOT_USER - MinIO username
#   MINIO_ROOT_PASSWORD - MinIO password

set -e

HOST="${SSH_HOST:-$1}"
USER="${SSH_USER:-${2:-root}}"
KEY_FILE=""

# –ü–∞—Ä—Å–∏–Ω–≥ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
shift 2 2>/dev/null || true
while [[ $# -gt 0 ]]; do
    case $1 in
        --key-file)
            KEY_FILE="$2"
            shift 2
            ;;
        --help)
            echo "Usage: $0 <host> <user> [--key-file <path>]"
            echo ""
            echo "Arguments:"
            echo "  host              SSH host (or use SSH_HOST env)"
            echo "  user              SSH user (or use SSH_USER env)"
            echo ""
            echo "Options:"
            echo "  --key-file PATH   Path to SSH private key"
            echo ""
            echo "Environment variables:"
            echo "  SSH_KEY              SSH private key content (for CI/CD)"
            echo "  SSH_HOST             SSH host"
            echo "  SSH_USER             SSH user"
            echo "  SECRET_KEY           Flask secret key"
            echo "  MINIO_ROOT_USER      MinIO username"
            echo "  MINIO_ROOT_PASSWORD  MinIO password"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

if [ -z "$HOST" ]; then
    echo "Error: HOST is required"
    echo "Use: $0 <host> <user> or set SSH_HOST environment variable"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è CI/CD
if [ -n "$SSH_KEY" ]; then
    # –†–µ–∂–∏–º CI/CD - –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ secrets
    if [ -z "$SECRET_KEY" ]; then
        echo "Error: SECRET_KEY is required"
        echo "Add SECRET_KEY to GitHub Secrets"
        exit 1
    fi
    if [ -z "$MINIO_ROOT_USER" ] || [ -z "$MINIO_ROOT_PASSWORD" ]; then
        echo "Error: MINIO_ROOT_USER and MINIO_ROOT_PASSWORD are required"
        echo "Add them to GitHub Secrets"
        exit 1
    fi
fi

echo "üöÄ Remote deployment to $HOST (Docker)"
echo "======================================="

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –∫–ª—é—á–∞ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è (–¥–ª—è GitHub Actions)
if [ -n "$SSH_KEY" ]; then
    echo "Setting up SSH key from environment..."
    mkdir -p ~/.ssh
    echo "$SSH_KEY" > ~/.ssh/deploy_key
    chmod 600 ~/.ssh/deploy_key
    KEY_FILE=~/.ssh/deploy_key
fi

# –§–æ—Ä–º–∏—Ä—É–µ–º SSH –∫–æ–º–∞–Ω–¥—É
SSH_CMD="ssh -o StrictHostKeyChecking=no"
SCP_CMD="scp -o StrictHostKeyChecking=no"
if [ -n "$KEY_FILE" ]; then
    SSH_CMD="$SSH_CMD -i $KEY_FILE"
    SCP_CMD="$SCP_CMD -i $KEY_FILE"
fi

echo "Connecting to $USER@$HOST..."
echo ""

# –°–æ–∑–¥–∞–µ–º .env –ª–æ–∫–∞–ª—å–Ω–æ –∏ –∫–æ–ø–∏—Ä—É–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä (—Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ CI/CD)
if [ -n "$SECRET_KEY" ]; then
    echo "üìù Creating .env file..."

    ENV_CONTENT="# DOCX Template Filler - Environment Configuration
# Auto-generated by GitHub Actions on $(date -u +"%Y-%m-%d %H:%M:%S UTC")
# DO NOT EDIT MANUALLY - managed by CI/CD

SECRET_KEY=${SECRET_KEY}
MINIO_ROOT_USER=${MINIO_ROOT_USER}
MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
S3_ENDPOINT=minio:9000
S3_BUCKET=templates
FLASK_ENV=production
"

    # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    ENV_TMP=$(mktemp)
    echo "$ENV_CONTENT" > "$ENV_TMP"

    # –ö–æ–ø–∏—Ä—É–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    echo "üì§ Uploading .env to server..."
    $SCP_CMD "$ENV_TMP" "$USER@$HOST:/tmp/.env.new"
    rm -f "$ENV_TMP"
fi

# –í—ã–ø–æ–ª–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ
$SSH_CMD $USER@$HOST << 'ENDSSH'
set -e

APP_DIR="/home/docxapp/docx-template-filler"

echo "üì• Updating on server (Docker deployment)..."
cd $APP_DIR || exit 1

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
echo "1Ô∏è‚É£ Pulling latest code..."
su - docxapp -c "cd docx-template-filler && git fetch origin && git reset --hard origin/main"

# –ü–µ—Ä–µ–º–µ—â–∞–µ–º .env –µ—Å–ª–∏ –±—ã–ª –∑–∞–≥—Ä—É–∂–µ–Ω
echo "2Ô∏è‚É£ Setting up environment..."
if [ -f "/tmp/.env.new" ]; then
    mv /tmp/.env.new "$APP_DIR/.env"
    chown docxapp:docxapp "$APP_DIR/.env"
    chmod 600 "$APP_DIR/.env"
    echo "   .env updated from CI/CD"
elif [ ! -f "$APP_DIR/.env" ]; then
    echo "‚ùå Error: .env file not found!"
    echo "Add SECRET_KEY, MINIO_ROOT_USER, MINIO_ROOT_PASSWORD to GitHub Secrets"
    exit 1
fi

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è volumes
echo "3Ô∏è‚É£ Creating data directories..."
su - docxapp -c "cd docx-template-filler && mkdir -p data uploads output docx_templates"

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ systemd —Å–µ—Ä–≤–∏—Å–∞ (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω)
echo "4Ô∏è‚É£ Stopping old systemd service (if running)..."
systemctl stop docxapp 2>/dev/null || true
systemctl disable docxapp 2>/dev/null || true

# –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ Docker
echo "5Ô∏è‚É£ Building and starting Docker containers..."
su - docxapp -c "cd docx-template-filler && docker compose down 2>/dev/null || true"
su - docxapp -c "cd docx-template-filler && docker compose build --no-cache"
su - docxapp -c "cd docx-template-filler && docker compose up -d"

sleep 5

# –ü—Ä–æ–≤–µ—Ä–∫–∞
echo ""
echo "6Ô∏è‚É£ Checking status..."
su - docxapp -c "cd docx-template-filler && docker compose ps"

echo ""
echo "Waiting for application to start..."
sleep 5

RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "http://127.0.0.1:5000/health" || echo "000")
if [ "$RESPONSE" = "200" ]; then
    echo ""
    echo "‚úÖ Application is running (HTTP $RESPONSE)"
else
    echo ""
    echo "‚ö†Ô∏è  Application status: HTTP $RESPONSE"
    echo "Checking logs..."
    su - docxapp -c "cd docx-template-filler && docker compose logs --tail=20 web"
    exit 1
fi

ENDSSH

echo ""
echo "======================================="
echo "‚úÖ Docker deployment complete!"
echo "======================================="

# –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞
if [ -f ~/.ssh/deploy_key ]; then
    rm -f ~/.ssh/deploy_key
fi

exit 0
