name: Scheduled Backup

on:
  schedule:
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ ÐºÐ°Ð¶Ð´ÑƒÑŽ Ð½ÐµÐ´ÐµÐ»ÑŽ Ð² Ð²Ð¾ÑÐºÑ€ÐµÑÐµÐ½ÑŒÐµ Ð² 3:00 UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:  # ÐœÐ¾Ð¶Ð½Ð¾ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      env:
        SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key

    - name: Run backup on VPS
      env:
        SSH_HOST: ${{ secrets.VPS_HOST }}
        SSH_USER: ${{ secrets.VPS_USER }}
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << 'ENDSSH'
          cd /home/docxapp/docx-template-filler

          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð±ÑÐºÐ°Ð¿Ð¾Ð²
          mkdir -p ~/backups

          # Ð‘ÑÐºÐ°Ð¿ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
          if [ -f templates.db ]; then
            cp templates.db ~/backups/templates_$(date +%Y%m%d).db
            echo "âœ… Database backed up"
          fi

          # Ð‘ÑÐºÐ°Ð¿ MinIO Ð´Ð°Ð½Ð½Ñ‹Ñ…
          if docker ps | grep -q docx-minio; then
            docker run --rm \
              -v minio-data:/data \
              -v ~/backups:/backup \
              alpine tar czf /backup/minio_$(date +%Y%m%d).tar.gz /data
            echo "âœ… MinIO data backed up"
          fi

          # Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð±ÑÐºÐ°Ð¿Ð¾Ð²
          echo ""
          echo "ðŸ“¦ Available backups:"
          ls -lh ~/backups/ | tail -10

          # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð±ÑÐºÐ°Ð¿Ñ‹ (ÑÑ‚Ð°Ñ€ÑˆÐµ 30 Ð´Ð½ÐµÐ¹)
          find ~/backups/ -type f -mtime +30 -delete
        ENDSSH

    - name: Cleanup
      if: always()
      run: |
        rm -f ~/.ssh/deploy_key

    - name: Send notification
      if: always()
      run: |
        if [ $? -eq 0 ]; then
          echo "âœ… Backup completed successfully"
        else
          echo "âŒ Backup failed"
        fi
